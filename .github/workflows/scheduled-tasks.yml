# ============================================================================
# Scheduled Tasks Workflow
# ============================================================================
#
# "Sleep! That's where I'm a Viking!" - Ralph Wiggum
#
# This workflow handles scheduled maintenance tasks while we sleep!
#
# Schedule:
# - Daily at 2:00 AM UTC: Cleanup and health checks
# - Weekly on Sunday at 3:00 AM UTC: Extended maintenance
#
# Tasks:
# - Cleanup old artifacts
# - Database maintenance hints
# - Cache warmup
# - Security scan
# - Dependency updates check
#
# ============================================================================

name: Scheduled - Maintenance Tasks

on:
  schedule:
    # Daily at 2:00 AM UTC
    - cron: '0 2 * * *'
    # Weekly on Sunday at 3:00 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to run'
        required: true
        type: choice
        options:
          - all
          - cleanup
          - security-scan
          - dependency-check
          - health-check

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # ============================================================================
  # Daily Tasks
  # ============================================================================
  cleanup:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    if: ${{ github.event.schedule == '0 2 * * *' || github.event.inputs.task == 'all' || github.event.inputs.task == 'cleanup' }}

    steps:
      - name: Cleanup workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10
        continue-on-error: true

      - name: Report cleanup
        run: |
          echo "üßπ Cleanup completed"
          echo "- Removed workflow runs older than 30 days"
          echo "- Kept minimum 10 runs per workflow"

  health-check:
    name: Environment Health Checks
    runs-on: ubuntu-latest
    if: ${{ github.event.schedule == '0 2 * * *' || github.event.inputs.task == 'all' || github.event.inputs.task == 'health-check' }}

    strategy:
      matrix:
        environment:
          - name: dev
            url: https://app-dorise-api-dev.azurewebsites.net
          - name: stg
            url: https://app-dorise-api-stg.azurewebsites.net
          - name: prod
            url: https://app-dorise-api-prod.azurewebsites.net

    steps:
      - name: Check ${{ matrix.environment.name }} health
        run: |
          echo "üè• Checking ${{ matrix.environment.name }} environment..."

          response=$(curl -s -o /dev/null -w "%{http_code}" \
            "${{ matrix.environment.url }}/health" \
            --max-time 30 || echo "000")

          if [ "$response" = "200" ]; then
            echo "‚úÖ ${{ matrix.environment.name }}: Healthy"
          else
            echo "‚ö†Ô∏è ${{ matrix.environment.name }}: Status $response"
          fi
        continue-on-error: true

  # ============================================================================
  # Weekly Tasks
  # ============================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: ${{ github.event.schedule == '0 3 * * 0' || github.event.inputs.task == 'all' || github.event.inputs.task == 'security-scan' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'HIGH,CRITICAL'
        continue-on-error: true

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ""
          head: HEAD
          extra_args: --only-verified
        continue-on-error: true

  dependency-check:
    name: Dependency Updates Check
    runs-on: ubuntu-latest
    if: ${{ github.event.schedule == '0 3 * * 0' || github.event.inputs.task == 'all' || github.event.inputs.task == 'dependency-check' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Check for outdated packages
        run: |
          echo "üì¶ Checking for outdated NuGet packages..."
          dotnet list src/Dorise.Incentive.sln package --outdated || true
        continue-on-error: true

      - name: Check for deprecated packages
        run: |
          echo "‚ö†Ô∏è Checking for deprecated packages..."
          dotnet list src/Dorise.Incentive.sln package --deprecated || true
        continue-on-error: true

      - name: Check for vulnerable packages
        run: |
          echo "üîí Checking for vulnerable packages..."
          dotnet list src/Dorise.Incentive.sln package --vulnerable || true
        continue-on-error: true

  # ============================================================================
  # Summary Report
  # ============================================================================
  summary:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [cleanup, health-check, security-scan, dependency-check]
    if: always()

    steps:
      - name: Generate report
        run: |
          echo "üìä Maintenance Summary Report"
          echo "=============================="
          echo "Run: ${{ github.run_id }}"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Trigger: ${{ github.event_name }}"
          echo ""
          echo "Task Results:"
          echo "- Cleanup: ${{ needs.cleanup.result || 'skipped' }}"
          echo "- Health Check: ${{ needs.health-check.result || 'skipped' }}"
          echo "- Security Scan: ${{ needs.security-scan.result || 'skipped' }}"
          echo "- Dependency Check: ${{ needs.dependency-check.result || 'skipped' }}"
          echo "=============================="
