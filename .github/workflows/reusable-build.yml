# ============================================================================
# Reusable Workflow - Build .NET Application
# ============================================================================
#
# "My cat's breath smells like cat food." - Ralph Wiggum
#
# This reusable workflow builds .NET applications consistently across all pipelines!
#
# Usage:
#   jobs:
#     build:
#       uses: ./.github/workflows/reusable-build.yml
#       with:
#         solution-path: src/Dorise.Incentive.sln
#         configuration: Release
#         run-tests: true
#
# ============================================================================

name: Reusable - Build .NET

on:
  workflow_call:
    inputs:
      solution-path:
        description: 'Path to the solution file'
        required: true
        type: string
      configuration:
        description: 'Build configuration (Debug/Release)'
        required: false
        type: string
        default: 'Release'
      dotnet-version:
        description: '.NET SDK version'
        required: false
        type: string
        default: '8.0.x'
      run-tests:
        description: 'Run unit tests'
        required: false
        type: boolean
        default: true
      publish-project:
        description: 'Project to publish (empty to skip)'
        required: false
        type: string
        default: ''
      artifact-name:
        description: 'Name for the build artifact'
        required: false
        type: string
        default: 'build-output'
      version:
        description: 'Version number for the build'
        required: false
        type: string
        default: ''

    outputs:
      artifact-name:
        description: 'Name of the uploaded artifact'
        value: ${{ jobs.build.outputs.artifact-name }}
      build-succeeded:
        description: 'Whether the build succeeded'
        value: ${{ jobs.build.outputs.build-succeeded }}

env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  NUGET_XMLDOC_MODE: skip

jobs:
  build:
    name: Build & Test
    runs-on: ubuntu-latest

    outputs:
      artifact-name: ${{ inputs.artifact-name }}
      build-succeeded: ${{ steps.build.outcome == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore ${{ inputs.solution-path }}
        continue-on-error: true

      - name: Build solution
        id: build
        run: |
          BUILD_ARGS="--configuration ${{ inputs.configuration }} --no-restore"

          if [ -n "${{ inputs.version }}" ]; then
            BUILD_ARGS="$BUILD_ARGS -p:Version=${{ inputs.version }}"
          fi

          dotnet build ${{ inputs.solution-path }} $BUILD_ARGS
        continue-on-error: true

      - name: Run unit tests
        if: ${{ inputs.run-tests }}
        run: |
          dotnet test ${{ inputs.solution-path }} \
            --configuration ${{ inputs.configuration }} \
            --no-build \
            --verbosity normal \
            --collect:"XPlat Code Coverage" \
            --results-directory ./test-results \
            --logger "trx;LogFileName=test-results.trx"
        continue-on-error: true

      - name: Upload test results
        if: ${{ inputs.run-tests && always() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ./test-results
          retention-days: 7
        continue-on-error: true

      - name: Publish project
        if: ${{ inputs.publish-project != '' }}
        run: |
          PUBLISH_ARGS="--configuration ${{ inputs.configuration }} --output ./publish --no-build"

          if [ -n "${{ inputs.version }}" ]; then
            PUBLISH_ARGS="$PUBLISH_ARGS -p:Version=${{ inputs.version }}"
          fi

          dotnet publish ${{ inputs.publish-project }} $PUBLISH_ARGS
        continue-on-error: true

      - name: Upload build artifact
        if: ${{ inputs.publish-project != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ./publish
          retention-days: 7
