# ============================================================================
# Infrastructure Pipeline - Deploy Azure Resources
# ============================================================================
#
# "Slow down, Bart! My legs don't know how to be as long as yours." - Ralph Wiggum
#
# This pipeline deploys Azure infrastructure at its own pace - carefully and correctly!
#
# Triggers:
# - Manual workflow dispatch only (for safety)
#
# Jobs:
# - Validate Bicep templates
# - What-if deployment preview
# - Deploy infrastructure (with approval)
#
# ============================================================================

name: Infrastructure - Deploy Azure Resources

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - stg
          - prod
      action:
        description: 'Deployment action'
        required: true
        type: choice
        options:
          - what-if
          - deploy
        default: 'what-if'

env:
  AZURE_LOCATION: 'eastus'

jobs:
  # ============================================================================
  # Validate Templates
  # ============================================================================
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Validate Bicep
        run: |
          echo "üîç Validating Bicep templates for ${{ github.event.inputs.environment }} environment..."
          az bicep build --file infra/main.bicep
          echo "‚úÖ Bicep templates are valid"

      - name: Logout from Azure
        run: az logout
        if: always()

  # ============================================================================
  # What-If Preview
  # ============================================================================
  what-if:
    name: What-If Preview
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Run What-If
        run: |
          echo "üîÆ Running what-if deployment preview for ${{ github.event.inputs.environment }}..."
          az deployment sub what-if \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters infra/parameters/${{ github.event.inputs.environment }}.bicepparam \
            --parameters sqlAdminLogin=${{ secrets.SQL_ADMIN_LOGIN }} \
            --parameters sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
        continue-on-error: true

      - name: Logout from Azure
        run: az logout
        if: always()

  # ============================================================================
  # Deploy Infrastructure
  # ============================================================================
  deploy:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: what-if
    if: ${{ github.event.inputs.action == 'deploy' }}
    environment:
      name: infrastructure-${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Deploy Bicep templates
        run: |
          echo "üöÄ Deploying infrastructure to ${{ github.event.inputs.environment }}..."
          az deployment sub create \
            --location ${{ env.AZURE_LOCATION }} \
            --template-file infra/main.bicep \
            --parameters infra/parameters/${{ github.event.inputs.environment }}.bicepparam \
            --parameters sqlAdminLogin=${{ secrets.SQL_ADMIN_LOGIN }} \
            --parameters sqlAdminPassword=${{ secrets.SQL_ADMIN_PASSWORD }} \
            --name "dsif-${{ github.event.inputs.environment }}-$(date +%Y%m%d-%H%M%S)"
          echo "‚úÖ Infrastructure deployment completed successfully"
        continue-on-error: true

      - name: Display outputs
        run: |
          echo "üìã Deployment outputs:"
          az deployment sub show \
            --name "dsif-${{ github.event.inputs.environment }}-*" \
            --query properties.outputs
        continue-on-error: true

      - name: Logout from Azure
        run: az logout
        if: always()

  # ============================================================================
  # Post-Deployment Validation
  # ============================================================================
  post-deploy:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: deploy
    if: ${{ github.event.inputs.action == 'deploy' }}

    steps:
      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
        continue-on-error: true

      - name: Verify resources
        run: |
          echo "üîç Verifying deployed resources..."
          RESOURCE_GROUP="rg-dorise-${{ github.event.inputs.environment }}-${{ env.AZURE_LOCATION }}"

          echo "Resources in $RESOURCE_GROUP:"
          az resource list --resource-group $RESOURCE_GROUP --output table

          echo "‚úÖ Post-deployment validation completed"
        continue-on-error: true

      - name: Logout from Azure
        run: az logout
        if: always()
